var BlockDrop=BlockDrop||function(a){"use strict";console.log("BlockDrop");var b=BlockDrop.Game,c=BlockDrop.Game.UI,d=BlockDrop.Game.Input,e=BlockDrop.Game.HighScores,f=BlockDrop.Game.Settings,g=BlockDrop.AudioLibrary,h={base:a&&a.base?a.base:"body"},i="#"===h.base[0]?document.getElementById(h.base.substr(1)):document.getElementsByTagName(h.base)[0];if(!i)throw new Error("Could not find base element: "+h.base);return f.initialise(),e.load(),g.load("move","audio/ecafbd56.blip.wav"),g.load("drop","audio/97255146.drop.wav"),g.load("rotate","audio/ddd73fe2.rotate.wav"),g.load("clear","audio/71333956.clear.wav"),g.load("tetris","audio/5a84f6b6.tetris.wav"),g.load("music","audio/ce655001.Havok.ogg",{loop:!0,play:f.get("music")}),c.initialise(i),d.setupEventListeners(),c.show("menu"),b};BlockDrop.namespace=function(a){"use strict";var b,c,d=a.split("."),e=BlockDrop;for("BlockDrop"===d[0]&&(d=d.slice(1)),b=0,c=d.length;c>b;b++)"undefined"==typeof e[d[b]]&&(e[d[b]]={}),e=e[d[b]];return e},BlockDrop.namespace("BlockDrop.Utils"),BlockDrop.Utils=function(a){"use strict";console.log("BlockDrop.Utils");var b=function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},c=function(a){return a.replace(/[^a-zA-Z0-9]/g,"")},d=function(a){var b,c,d,e=0;if(0===a.length)return e;for(b=0,c=a.length;c>b;b++)d=a.charCodeAt(b),e=(e<<5)-e+d,e|=0;return e.toString()},e=function(a){return"true"===a&&"0"!==a},f=function(a,b){return parseInt(a.dataset[b],10)},g=function(a,b,c){a.dataset[b]=c.toString()};return a.escapeRegExp=b,a.makeKeySafe=c,a.hashCode=d,a.parseBool=e,a.getIntData=f,a.setIntData=g,a}(BlockDrop.Utils),BlockDrop.namespace("BlockDrop.AudioLibrary"),BlockDrop.AudioLibrary=function(a){"use strict";console.log("BlockDrop.AudioLibrary");var b={},c=function(a,c,d){b[a]=new Audio(c),b[a].loop=d&&!!d.loop,d&&d.play&&b[a].play()},d=function(a){b[a]&&b[a].play()},e=function(a){b[a]&&b[a].pause()},f=function(a){b[a]&&(b[a].pause(),b[a].currentTime=0)};return a.load=c,a.play=d,a.pause=e,a.stop=f,a}(BlockDrop.AudioLibrary),BlockDrop.namespace("BlockDrop.TemplateEngine"),BlockDrop.TemplateEngine=function(a){"use strict";console.log("BlockDrop.TemplateEngine");var b=BlockDrop.Utils,c=new XMLHttpRequest,d=JSON.parse(localStorage.getItem("BlockDrop.cache.template"))||{},e=function(a){var e=d[b.hashCode(a)];return e||(e="",c.onreadystatechange=function(){4===c.readyState&&200===c.status&&(e=c.responseText)},c.open("GET",a,!1),c.send(),d[b.hashCode(a)]=e,localStorage.setItem("BlockDrop.cache.template",JSON.stringify(d))),e},f=function(a,b){return a.replace(/\{\{\s*([a-zA-Z0-9\.\$_]+)\s*}}/g,function(){var a=arguments[1].split(".");return void 0!==b[a[a.length-1]]?b[a[a.length-1]]:""})},g=function(a,b){return a.replace(/\{\{\s*repeat\s+([a-zA-Z0-9]+)\s+as\s+([a-zA-Z0-9]+)\s*}}([\s\S]+)\{\{\s*endrepeat\s*}}/g,function(){var a=arguments[1],c=arguments[3],d="";if(void 0!==b[a]&&b[a]instanceof Array)for(var e=0;e<b[a].length;e++)b[a][e].$index=e+1,d+=f(c,b[a][e]);return d})},h=function(a,b){return a=g(a,b),f(a,b)},i=function(a){var b=document.implementation.createHTMLDocument("");return b.body.innerHTML=a,b.querySelector("body").children[0]},j=function(a,b){var c=e(a);return b?h(c,b):c},k=function(a,b){var c=j(a,b);return i(c)};return a.getString=j,a.get=k,a}(BlockDrop.TemplateEngine),BlockDrop.namespace("BlockDrop.Game.Settings"),BlockDrop.Game.Settings=function(a){"use strict";console.log("BlockDrop.Game.Settings");var b=BlockDrop.Utils,c={},d=function(){var a=localStorage.getItem("BlockDrop.settings.music"),d=localStorage.getItem("BlockDrop.settings.sound");c.music=a?b.parseBool(a):f("music",!0),c.sound=d?b.parseBool(d):f("sound",!0)},e=function(a){return c[a]},f=function(a,b){return c[a]=b,localStorage.setItem("BlockDrop.settings."+a,b),c[a]},g=function(a){return f(a,!e(a)),e(a)};return a.initialise=d,a.get=e,a.set=f,a.toggle=g,a}(BlockDrop.Game.Settings),BlockDrop.namespace("BlockDrop.Game.Score"),BlockDrop.Game.Score=function(a){"use strict";console.log("BlockDrop.Game.Score");var b=0,c=0,d=1,e=0,f=function(){b=0,c=0,d=1},g=function(){e=0},h=function(){return b},i=function(){return c},j=function(){return d},k=function(a){switch(a){case 4:b+=1200*d;break;case 3:b+=300*d;break;case 2:b+=100*d;break;case 1:b+=40*d}return b+=e},l=function(){c++},m=function(){d++},n=function(){e++};return a.reset=f,a.resetDropLength=g,a.getScore=h,a.getLines=i,a.getLevel=j,a.incrementScore=k,a.incrementLines=l,a.incrementLevel=m,a.incrementDrop=n,a}(BlockDrop.Game.Score),BlockDrop.namespace("BlockDrop.Game.HighScores"),BlockDrop.Game.HighScores=function(a){"use strict";console.log("BlockDrop.Game.HighScores");var b=BlockDrop.Game.Score,c=[],d=function(a,b){return a.score<b.score?1:a.score>b.score?-1:0},e=function(){c=JSON.parse(localStorage.getItem("BlockDrop.scores"))||[]},f=function(a){c[c.length]={score:b.getScore(),name:a},c.sort(d),c.length>20&&(c.length=20),localStorage.setItem("BlockDrop.scores",JSON.stringify(c))},g=function(){return c};return a.load=e,a.save=f,a.get=g,a}(BlockDrop.Game.HighScores),BlockDrop.namespace("BlockDrop.Game.PieceFactory"),BlockDrop.Game.PieceFactory=function(a){"use strict";console.log("BlockDrop.Game.PieceFactory");var b=BlockDrop.TemplateEngine,c=BlockDrop.Utils,d=[{id:"o",size:2,blocks:{r0:[{left:0,top:0},{left:1,top:0},{left:0,top:1},{left:1,top:1}],r90:[{left:0,top:0},{left:1,top:0},{left:0,top:1},{left:1,top:1}],r180:[{left:0,top:0},{left:1,top:0},{left:0,top:1},{left:1,top:1}],r270:[{left:0,top:0},{left:1,top:0},{left:0,top:1},{left:1,top:1}]}},{id:"l",size:3,blocks:{r0:[{left:2,top:0},{left:0,top:1},{left:1,top:1},{left:2,top:1}],r90:[{left:1,top:0},{left:1,top:1},{left:1,top:2},{left:2,top:2}],r180:[{left:0,top:1},{left:1,top:1},{left:2,top:1},{left:0,top:2}],r270:[{left:0,top:0},{left:1,top:0},{left:1,top:1},{left:1,top:2}]}},{id:"j",size:3,blocks:{r0:[{left:0,top:0},{left:0,top:1},{left:1,top:1},{left:2,top:1}],r90:[{left:1,top:0},{left:2,top:0},{left:1,top:1},{left:1,top:2}],r180:[{left:0,top:1},{left:1,top:1},{left:2,top:1},{left:2,top:2}],r270:[{left:1,top:0},{left:1,top:1},{left:0,top:2},{left:1,top:2}]}},{id:"s",size:3,blocks:{r0:[{left:1,top:0},{left:2,top:0},{left:0,top:1},{left:1,top:1}],r90:[{left:1,top:0},{left:1,top:1},{left:2,top:1},{left:2,top:2}],r180:[{left:1,top:1},{left:2,top:1},{left:0,top:2},{left:1,top:2}],r270:[{left:0,top:0},{left:0,top:1},{left:1,top:1},{left:1,top:2}]}},{id:"z",size:3,blocks:{r0:[{left:0,top:0},{left:1,top:0},{left:1,top:1},{left:2,top:1}],r90:[{left:2,top:0},{left:1,top:1},{left:2,top:1},{left:1,top:2}],r180:[{left:0,top:1},{left:1,top:1},{left:1,top:2},{left:2,top:2}],r270:[{left:1,top:0},{left:0,top:1},{left:1,top:1},{left:0,top:2}]}},{id:"t",size:3,blocks:{r0:[{left:1,top:0},{left:0,top:1},{left:1,top:1},{left:2,top:1}],r90:[{left:1,top:0},{left:1,top:1},{left:2,top:1},{left:1,top:2}],r180:[{left:0,top:1},{left:1,top:1},{left:2,top:1},{left:1,top:2}],r270:[{left:1,top:0},{left:0,top:1},{left:1,top:1},{left:1,top:2}]}},{id:"i",size:4,blocks:{r0:[{left:0,top:1},{left:1,top:1},{left:2,top:1},{left:3,top:1}],r90:[{left:2,top:0},{left:2,top:1},{left:2,top:2},{left:2,top:3}],r180:[{left:0,top:2},{left:1,top:2},{left:2,top:2},{left:3,top:2}],r270:[{left:1,top:0},{left:1,top:1},{left:1,top:2},{left:1,top:3}]}}],e=function(a,e){var f,g,h,i,j;for(e>=0&&360>e&&e%90===0||(e=0),"number"==typeof a&&a>=0&&a<d.length||(a=Math.floor(Math.random()*d.length)),f=d[a],h=b.get("template/bf5ee5bd.block.tpl.html",{id:f.id}),h.style.width=f.size+"em",h.style.height=f.size+"em",g=f.blocks["r"+e],i=0,j=g.length;j>i;i++)h.children[i].style.top=g[i].top+"em",h.children[i].style.left=g[i].left+"em";return c.setIntData(h,"index",a),c.setIntData(h,"rotate",e),c.setIntData(h,"size",f.size),h},f=function(a,b){return d[a].blocks["r"+b]};return a.create=e,a.getMap=f,a}(BlockDrop.Game.PieceFactory),BlockDrop.namespace("BlockDrop.Game.UI"),BlockDrop.Game.UI=function(a){"use strict";console.log("BlockDrop.Game.UI");var b=BlockDrop.Game.PieceFactory,c=BlockDrop.Game.Score,d=BlockDrop.Game.HighScores,e=BlockDrop.Game.Settings,f=BlockDrop.TemplateEngine,g=BlockDrop.Utils,h=30,i={},j=function(a){var b,g=16.5,i=21;b=g/i,h=Math.floor(window.innerWidth/window.innerHeight>b?window.innerHeight/i:window.innerWidth/g),a.style.fontSize=h+"px",a.appendChild(f.get("template/a069dc8f.board.tpl.html",{margin:Math.floor((window.innerHeight-h*i)/2),settingsMusic:e.get("music"),settingsSound:e.get("sound")})),l("wrappers.game",a.querySelector("#game-board")),l("wrappers.info",a.querySelector("#game-info")),l("wrappers.next",a.querySelector("#game-next").querySelector(".container")),l("status.score",a.querySelector("#game-score").querySelector(".value")),l("status.level",a.querySelector("#game-level").querySelector(".value")),l("status.lines",a.querySelector("#game-lines").querySelector(".value")),l("buttons.music",a.querySelector("#button-music")),l("buttons.sound",a.querySelector("#button-sound")),l("buttons.start",f.get("template/808cb126.button.tpl.html",{name:"start",value:"Start"})),l("buttons.about",f.get("template/808cb126.button.tpl.html",{name:"about",value:"About"})),l("buttons.scores",f.get("template/808cb126.button.tpl.html",{name:"scores",value:"High Scores"})),l("buttons.pause",f.get("template/808cb126.button.tpl.html",{name:"pause",value:"Pause"})),l("buttons.resume",f.get("template/808cb126.button.tpl.html",{name:"resume",value:"Resume"})),l("buttons.quit",f.get("template/808cb126.button.tpl.html",{name:"quit",value:"Quit"})),l("dialogs.info",f.get("template/3cc57c07.dialog.tpl.html",{name:"info",title:"About BlockDrop",content:f.getString("template/7d96399c.about.tpl.html")})),l("dialogs.finish",f.get("template/3cc57c07.dialog.tpl.html",{name:"finish",title:"Game Over!",content:f.getString("template/394bfa9b.finish.tpl.html",{score:c.getScore()})})),l("inputs.name",m("dialogs.finish").querySelector("#score_name")),l("dialogs.scores",f.get("template/3cc57c07.dialog.tpl.html",{name:"scores",title:"High Scores",content:f.getString("template/e2042882.scores.tpl.html",{scores:d.get()})}))},k=function(){return h},l=function(a,b){var c,d,e=a.split("."),f=i;for(c=0,d=e.length;d>c;c++)c===d-1?f[e[c]]=b:"undefined"==typeof f[e[c]]&&(f[e[c]]={}),f=f[e[c]];return b},m=function(a){var b,c,d=a.split("."),e=i;for(b=0,c=d.length;c>b;b++){if("undefined"==typeof e[d[b]])return!1;e=e[d[b]]}return e},n=function(){var a,c,d=m("wrappers.game"),e=m("wrappers.next");a=d.appendChild(l("pieces.current",b.create())),a.style.top="-1em",a.style.left=5-Math.round(g.getIntData(a,"size")/2)+"em",c=e.appendChild(l("pieces.next",b.create())),c.style.top=(4-g.getIntData(c,"size"))/2+"em",c.style.left=(4-g.getIntData(c,"size"))/2+"em"},o=function(){var a,c=m("wrappers.game"),d=m("wrappers.next"),e=m("pieces.next");return a=l("pieces.current",d.removeChild(e)),c.appendChild(a),a.style.top="-1em",a.style.left=5-Math.round(g.getIntData(a,"size")/2)+"em",e=l("pieces.next",d.appendChild(b.create())),e.style.top=(4-g.getIntData(e,"size"))/2+"em",e.style.left=(4-g.getIntData(e,"size"))/2+"em",a},p=function(a){a=a||m("pieces.current"),a.style.left=a.offsetLeft/k()-1+"em"},q=function(a){a=a||m("pieces.current"),a.style.left=a.offsetLeft/k()+1+"em"},r=function(a){a=a||m("pieces.current"),a.style.top=a.offsetTop/k()+1+"em"},s=function(a){a=a||m("pieces.current");var c,d,e,f,h=g.getIntData(a,"rotate");for(h+=90,h>=360&&(h=0),c=a.querySelectorAll(".piece-block"),d=b.getMap(g.getIntData(a,"index"),h),e=0,f=c.length;f>e;e++)c[e].style.left=d[e].left+"em",c[e].style.top=d[e].top+"em";g.setIntData(a,"rotate",h)},t=function(a){var b,e=m("wrappers.game"),g=e.parentElement,h=m("wrappers.info");switch(C(),a){case"menu":B(m("buttons.start"),e),B(m("buttons.about"),e),B(m("buttons.scores"),e);break;case"info":B(m("dialogs.info"),g);break;case"scores":l("dialogs.scores",f.get("template/3cc57c07.dialog.tpl.html",{name:"scores",title:"High Scores",content:f.getString("template/e2042882.scores.tpl.html",{scores:d.get()})})),B(m("dialogs.scores"),g);break;case"game":E(),B(m("buttons.pause"),h);break;case"pause-menu":D(),B(m("buttons.resume"),e),B(m("buttons.quit"),e);break;case"finish":l("dialogs.finish",f.get("template/3cc57c07.dialog.tpl.html",{name:"finish",title:"Game Over!",content:f.getString("template/394bfa9b.finish.tpl.html",{score:c.getScore()})})),b=l("inputs.name",m("dialogs.finish").querySelector("#score_name")),B(m("dialogs.finish"),g),b.focus()}},u=function(a){return a&&"true"===a.dataset.visible},v=function(){var a=m("status.score"),b=m("status.lines"),d=m("status.level");a.innerHTML=c.getScore(),b.innerHTML=c.getLines(),d.innerHTML=c.getLevel()},w=function(a){a=a||m("pieces.current");var b,c,d,e,f,g=a.querySelectorAll(".piece-block"),h=m("wrappers.game"),i=k();for(e=0,f=g.length;f>e;e++)b=a.offsetLeft+g[e].offsetLeft,c=a.offsetTop+g[e].offsetTop,d=a.removeChild(g[e]),d.style.left=b/i+"em",d.style.top=c/i+"em",h.appendChild(d);h.removeChild(a)},x=function(){var a,b,c,d,e=m("wrappers.game").querySelectorAll(".piece-block"),f=k(),g=[];for(a=19;a>=0;a--){for(b=0;10>b;b++){for(c=0,d=e.length;d>c&&(e[c].offsetTop!==a*f||e[c].offsetLeft!==b*f);c++);if(c===e.length)break}10===b&&g.push(a)}return g},y=function(a){var b,c,d=m("wrappers.game").querySelectorAll(".piece-block"),e=k(),f=[];for(b=0,c=d.length;c>b;b++)d[b].offsetTop===a*e?f.push(d[b]):d[b].offsetTop<a*e&&(d[b].style.top=d[b].offsetTop/e+1+"em");for(b=0;b<f.length;b++)f[b].parentElement.removeChild(f[b])},z=function(){var a,b,c=m("wrappers.game"),d=c.querySelectorAll(".piece-block"),e=m("pieces.current"),f=m("pieces.next"),g=m("wrappers.next");for(a=0,b=d.length;b>a;a++)d[a].parentElement!==e&&c.removeChild(d[a]);c.removeChild(e),g.removeChild(f)},A=function(a){return a.dataset.visible="false",a.parentElement.removeChild(a)},B=function(a,b){return a.dataset.visible="true",b.appendChild(a)},C=function(){var a,b,c=[m("buttons.start"),m("buttons.about"),m("buttons.scores"),m("buttons.pause"),m("buttons.resume"),m("buttons.quit"),m("dialogs.info"),m("dialogs.finish"),m("dialogs.scores")];for(a=0,b=c.length;b>a;a++)u(c[a])&&A(c[a])},D=function(){var a,b,c=m("wrappers.game").querySelectorAll(".piece-block"),d=m("pieces.next");for(a=0,b=c.length;b>a;a++)c[a].style.display="none";d.style.display="none"},E=function(){var a,b,c=m("wrappers.game").querySelectorAll(".piece-block"),d=m("pieces.next");for(a=0,b=c.length;b>a;a++)c[a].style.display="block";d.style.display="block"};return a.initialise=j,a.getBaseSize=k,a.getElement=m,a.loadFirstPieces=n,a.loadNextPiece=o,a.moveLeft=p,a.moveRight=q,a.moveDown=r,a.rotate=s,a.show=t,a.isVisible=u,a.drawElements=v,a.addCurrentPieceToBoard=w,a.findCompleteRows=x,a.clearCompleteRow=y,a.clearGameBoard=z,a}(BlockDrop.Game.UI),BlockDrop.namespace("BlockDrop.Game.CollisionDetection"),BlockDrop.Game.CollisionDetection=function(a){"use strict";console.log("BlockDrop.Game.CollisionDetection");var b=BlockDrop.Game.UI,c=BlockDrop.Game.PieceFactory,d=BlockDrop.Utils,e={BOTTOM:"bottomWall",LEFT:"leftWall",RIGHT:"rightWall",ALL:"all",BLOCKS:"otherBlocks"},f=function(a){a=a||b.getElement("pieces.current");var c={top:b.getBaseSize(),left:0};return!k(a,e.BOTTOM,c)},g=function(a){a=a||b.getElement("pieces.current");var c={top:0,left:-b.getBaseSize()};return!k(a,e.LEFT,c)},h=function(a){a=a||b.getElement("pieces.current");var c={top:0,left:b.getBaseSize()};return!k(a,e.RIGHT,c)},i=function(a){a=a||b.getElement("pieces.current");var f,i,j,l=d.getIntData(a,"index"),m=d.getIntData(a,"rotate"),n=d.getIntData(a,"size"),o=m+90,p=b.getElement("wrappers.game"),q=b.getBaseSize();return o>=360&&(o=0),f=p.appendChild(c.create(l,o)),f.style.zIndex="-1",f.style.left=a.offsetLeft/q+"em",f.style.top=a.offsetTop/q+"em",(i=k(f,e.ALL,{left:0,top:0}))?(j=1,4===n&&(i===e.LEFT&&90===m||i===e.RIGHT&&270===m)&&(j=2),i===e.LEFT&&h(f)?(a.style.left=a.offsetLeft/q+j+"em",p.removeChild(f),!0):i===e.RIGHT&&g(f)?(a.style.left=a.offsetLeft/q-j+"em",p.removeChild(f),!0):(p.removeChild(f),!1)):(p.removeChild(f),!0)},j=function(a){a=a||b.getElement("pieces.current");var c={top:0,left:0};return k(a,e.BOTTOM,c)},k=function(a,c,d){var f,g,h=a.querySelectorAll(".piece-block"),i=b.getBaseSize();if(c===e.LEFT||c===e.ALL)for(f=0,g=h.length;g>f;f++)if(a.offsetLeft+h[f].offsetLeft+d.left<0)return e.LEFT;if(c===e.RIGHT||c===e.ALL)for(f=0,g=h.length;g>f;f++)if(a.offsetLeft+h[f].offsetLeft+h[f].offsetWidth+d.left>10*i)return e.RIGHT;if(c===e.BOTTOM||c===e.ALL)for(f=0,g=h.length;g>f;f++)if(a.offsetTop+h[f].offsetTop+h[f].offsetHeight+d.top>20*i)return e.BOTTOM;return l(a,d)?e.BLOCKS:!1},l=function(a,c){var d,e,f,g,h=b.getElement("wrappers.game").querySelectorAll(".piece-block"),i=a.querySelectorAll(".piece-block"),j=b.getElement("pieces.current");for(d=0,f=h.length;f>d;d++)if(h[d].parentElement!==a&&h[d].parentElement!==j)for(e=0,g=i.length;g>e;e++)if(m({offsetLeft:a.offsetLeft+i[e].offsetLeft,offsetTop:a.offsetTop+i[e].offsetTop,offsetWidth:i[e].offsetWidth,offsetHeight:i[e].offsetHeight},h[d],c))return!0;return!1},m=function(a,b,c){return a.offsetTop+a.offsetHeight+c.top>b.offsetTop&&a.offsetTop+c.top<b.offsetTop+b.offsetHeight&&a.offsetLeft+a.offsetWidth+c.left>b.offsetLeft&&a.offsetLeft+c.left<b.offsetLeft+b.offsetWidth};return a.canMoveDown=f,a.canMoveLeft=g,a.canMoveRight=h,a.canRotate=i,a.isGameOver=j,a}(BlockDrop.Game.CollisionDetection),BlockDrop.namespace("BlockDrop.Game.Input"),BlockDrop.Game.Input=function(a){"use strict";console.log("BlockDrop.Game.Input");var b,c,d=BlockDrop.Game,e=BlockDrop.Game.Settings,f=BlockDrop.Game.UI,g=BlockDrop.Game.CollisionDetection,h=BlockDrop.Game.Score,i=BlockDrop.Game.HighScores,j=BlockDrop.AudioLibrary,k=BlockDrop.Utils,l=!1,m=!1,n=!1,o=function(){var a=f.getElement("pieces.current");g.canMoveLeft(a)&&(e.get("sound")&&(j.stop("move"),j.play("move")),f.moveLeft(a))},p=function(){var a=f.getElement("pieces.current");g.canMoveRight(a)&&(e.get("sound")&&(j.stop("move"),j.play("move")),f.moveRight(a))},q=function(){var a=f.getElement("pieces.current");return d.clearTimer(),g.canMoveDown(a)?(e.get("sound")&&(j.stop("move"),j.play("move")),f.moveDown(a),h.incrementDrop(),void d.startTimer()):void d.startDropTimer()},r=function(){for(;!d.isDropping();)q();e.get("sound")&&j.play("drop"),l=!0},s=function(){return l},t=function(){l=!1},u=function(){var a=f.getElement("pieces.current");g.canRotate(a)&&(e.get("sound")&&(j.stop("rotate"),j.play("rotate")),f.rotate(a))},v=function(a){var b,c=f.getElement("buttons.start"),g=f.getElement("buttons.about"),h=f.getElement("buttons.scores"),i=f.getElement("buttons.pause"),l=f.getElement("buttons.resume"),m=f.getElement("buttons.quit"),n=f.getElement("buttons.sound"),o=f.getElement("buttons.music");a.target===c?(d.start(),a.preventDefault()):a.target===g?(f.show("info"),a.preventDefault()):a.target===h?(f.show("scores"),a.preventDefault()):a.target===i?(d.pause(),a.preventDefault()):a.target===l?(d.resume(),a.preventDefault()):a.target===m?(d.finish({quit:!0}),a.preventDefault()):a.target===n||a.target.parentElement===n?(b=e.toggle("sound"),k.setIntData(n,"on",b),a.preventDefault()):a.target===o||a.target.parentElement===o?(b=e.toggle("music"),k.setIntData(o,"on",b),b?j.play("music"):j.pause("music"),a.preventDefault()):(a.target.classList.contains("close-button")||a.target.parentElement.classList.contains("close-button"))&&(f.show("menu"),a.preventDefault())},w=function(a){var b,c=f.getElement("wrappers.game").parentElement,e=f.getElement("buttons.start"),g=f.getElement("buttons.about"),h=f.getElement("buttons.scores"),j=f.getElement("buttons.resume"),k=f.getElement("buttons.quit"),l=f.getElement("buttons.sound"),m=f.getElement("buttons.music"),n=f.getElement("dialogs.info"),t=f.getElement("dialogs.finish"),v=f.getElement("dialogs.scores"),w=f.getElement("inputs.name"),x=a.keyCode||a.which;if(f.isVisible(t)&&a.target===w&&x)return void(13===x&&(i.save(w.value),f.show("scores")));if(18===x){b=c.querySelectorAll(".button");for(var y=0;y<b.length;y++)b[y]!==l&&b[y]!==m&&b[y].classList.add("hl-first");a.preventDefault()}if(d.isPlaying()&&!s())switch(x){case 37:case 72:case 65:o(),a.preventDefault();break;case 39:case 76:case 68:p(),a.preventDefault();break;case 38:case 75:case 87:u(),a.preventDefault();break;case 40:case 74:case 83:q(),a.preventDefault();break;case 13:case 32:r(),a.preventDefault();break;case 27:case 80:d.pause(),a.preventDefault()}else if(!d.isPlaying())switch(x){case 13:case 32:f.isVisible(e)?d.start():f.isVisible(j)&&d.resume(),a.preventDefault();break;case 83:f.isVisible(e)&&d.start(),a.preventDefault();break;case 65:f.isVisible(g)?f.show("info"):f.isVisible(n)&&f.show("menu"),a.preventDefault();break;case 72:f.isVisible(h)?f.show("scores"):f.isVisible(v)&&f.show("menu"),a.preventDefault();break;case 82:f.isVisible(j)&&d.resume(),a.preventDefault();break;case 81:f.isVisible(k)&&d.finish({quit:!0}),a.preventDefault();break;case 27:case 88:(f.isVisible(n)||f.isVisible(t)||f.isVisible(v))&&f.show("menu"),a.preventDefault()}},x=function(a){var b,c,d,e=f.getElement("wrappers.game").parentElement,g=f.getElement("buttons.sound"),h=f.getElement("buttons.music"),i=a.keyCode||a.which;if(18===i){for(b=e.querySelectorAll(".button"),c=0,d=b.length;d>c;c++)b[c]!==g&&b[c]!==h&&b[c].classList.remove("hl-first");a.preventDefault()}},y=function(a){var e=f.getElement("buttons.pause"),g=f.getElement("buttons.sound"),h=f.getElement("buttons.music");d.isPlaying()&&a.target!==e&&a.target!==g&&a.target.parentElement!==g&&a.target!==h&&a.target.parentElement!==h&&(b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY,m=!1,n=!1,a.preventDefault())},z=function(a){var b=f.getElement("buttons.pause"),c=f.getElement("buttons.sound"),e=f.getElement("buttons.music");d.isPlaying()&&a.target!==b&&a.target!==c&&a.target.parentElement!==c&&a.target!==e&&a.target.parentElement!==e&&(m||(u(),a.preventDefault()))},A=function(a){if(d.isPlaying()){var e=a.changedTouches[0].clientX,g=a.changedTouches[0].clientY,h=e-b,i=g-c,j=f.getBaseSize();Math.abs(h)>Math.abs(i)&&Math.abs(h)>=j&&"y"!==m[0]?(m="x",h>0?p():o(),b=e):Math.abs(h)<=Math.abs(i)&&Math.abs(i)>=j&&(i>=3*j?r():i>0?(m="y+",q()):m||(m="y-",u()),c=g),a.preventDefault()}},B=function(){var a=f.getElement("wrappers.game").parentElement;a.addEventListener("click",v),window.addEventListener("keydown",w),window.addEventListener("keyup",x),a.addEventListener("touchstart",y),a.addEventListener("touchend",z),a.addEventListener("touchmove",A)};return a.isHardDrop=s,a.resetHardDrop=t,a.setupEventListeners=B,a}(BlockDrop.Game.Input),BlockDrop.namespace("BlockDrop.Game"),BlockDrop.Game=function(a){"use strict";console.log("BlockDrop.Game");var b,c=BlockDrop.Game.Settings,d=BlockDrop.Game.UI,e=BlockDrop.Game.Score,f=BlockDrop.Game.CollisionDetection,g=BlockDrop.Game.Input,h=BlockDrop.AudioLibrary,i=!1,j=null,k=1e3,l=function(){d.loadFirstPieces(),e.reset(),d.drawElements(),i=!0,r(),d.show("game")},m=function(){s(),i=!1,d.show("pause-menu")},n=function(){i=!0,r(),d.show("game")},o=function(a){i=!1,d.clearGameBoard(),d.show(a&&a.quit?"menu":"finish")},p=function(){var a,b,i=d.getElement("pieces.current");if(u(),f.canMoveDown(i))d.moveDown(i),e.resetDropLength();else{for(!g.isHardDrop()&&c.get("sound")&&h.play("drop"),s(),d.addCurrentPieceToBoard(),a=d.findCompleteRows(),e.incrementScore(a.length),a.length&&c.get("sound")&&h.play(4===a.length?"tetris":"clear"),b=a.length;b>0;b--)d.clearCompleteRow(a[b-1]),e.incrementLines(),e.getLines()%10===0&&e.incrementLevel();d.loadNextPiece(),e.resetDropLength(),g.resetHardDrop(),f.isGameOver()?o({quit:!1}):r(),d.drawElements()}},q=function(){return i},r=function(){j=setInterval(p,k/e.getLevel())},s=function(){clearInterval(j),j=void 0},t=function(){return b||(b=setTimeout(p,k/2/e.getLevel())),b},u=function(){clearTimeout(b),b=void 0},v=function(){return!!b};return a.start=l,a.pause=m,a.resume=n,a.finish=o,a.isPlaying=q,a.startTimer=r,a.clearTimer=s,a.startDropTimer=t,a.isDropping=v,a}(BlockDrop.Game);